<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>Huewave Lab â€” å–®æª”å®Œæ•´ç‰ˆï¼ˆè‰²å½©åˆ†æï¼‹éŸ³è‰²é€£çµï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --gap: 12px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif; padding: 20px; line-height: 1.6; }
    h1 { margin: 0 0 6px; }
    .row { display: flex; gap: var(--gap); flex-wrap: wrap; align-items: center; }
    .col { display: flex; flex-direction: column; gap: var(--gap); }
    .card { border: 1px solid #eee; border-radius: 14px; padding: 14px; }
    button { padding: 8px 14px; border-radius: 10px; border: 1px solid #ddd; background: #fafafa; cursor: pointer; }
    button:disabled { opacity:.5; cursor: not-allowed; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#f2f2f2; margin-right:6px; font-size:12px; }
    .log { white-space: pre-wrap; background: #0a0a0a; color: #e7e7e7; padding: 12px; border-radius: 10px; max-height: 280px; overflow: auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .ok { color:#0a7f2e; } .warn { color:#b08400; } .err{ color:#b40000; }
    #preview { max-width: 100%; border-radius: 10px; display:none; }
    .swatches { display:flex; gap:8px; flex-wrap:wrap; }
    .swatch { width:32px; height:32px; border-radius:6px; border:1px solid #ddd; }
    .kv { display:grid; grid-template-columns: 120px 1fr; gap:6px 12px; }
    .kv b { color:#333; }
    .muted { color:#666; font-size:12px; }
  </style>
  <!-- Tone.jsï¼ˆCDNï¼‰ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <h1>Huewave Lab</h1>
  <div class="muted">å–®æª”å®Œæ•´ç‰ˆï¼šä¸Šå‚³åœ–ç‰‡ â†’ å–ä¸»è‰²èˆ‡å½©åº¦ â†’ æ±ºå®šæ›²é¢¨ â†’ è‡ªå‹•é€£çµ <code>samples/*</code> â†’ æ’­æ”¾ã€‚</div>

  <div class="row" style="margin-top:12px;">
    <!-- 1) ä¸Šå‚³åœ–ç‰‡ä¸¦åˆ†æä¸»è‰²ï¼ˆæ–°çš„ upload-areaï¼‰ -->
    <div class="card" style="flex:1; min-width: 280px;">
      <h3>1) ä¸Šå‚³åœ–ç‰‡ä¸¦åˆ†æä¸»è‰²</h3>
      <div id="upload-area" style="margin:20px;">
        <label for="photoInput">ğŸ“· ä¸Šå‚³ç…§ç‰‡ï¼ˆæ‰‹æ©ŸæƒQRå¾Œé¸ç…§ç‰‡ï¼‰</label><br>
        <input type="file" id="photoInput" accept="image/*">
        <button id="uploadBtn">ä¸Šå‚³ä¸¦åˆ†æ</button>
        <div id="swatches-upload" style="margin-top:10px;"></div>
        <div id="genre-pill" class="pill" style="margin-top:10px;">æ›²é¢¨ï¼šâ€”</div>
      </div>
    </div>

    <!-- 2) å»ºç«‹æ¨‚å™¨ -->
    <div class="card" style="flex:1; min-width: 280px;">
      <h3>2) å»ºç«‹æ¨‚å™¨</h3>
      <div>è³‡æ–™å¤¾è«‹ä¿æŒï¼š</div>
      <div>
        <span class="pill">samples/piano</span>
        <span class="pill">samples/saxophone</span>
        <span class="pill">samples/guitar</span>
        <span class="pill">samples/bass</span>
        <span class="pill">samples/drum/<i>Kdrum, Snare, HihatClosed, HihatOpen, Crash</i></span>
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="btn-start">è§£é–éŸ³è¨Š (å¿…æŒ‰)</button>
        <button id="btn-build">å»ºç«‹æ¨‚å™¨</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="test-piano" disabled>piano C4</button>
        <button id="test-sax" disabled>sax A4</button>
        <button id="test-guitar" disabled>guitar E4</button>
        <button id="test-bass" disabled>bass C2</button>
        <button id="test-drum" disabled>snare</button>
      </div>
    </div>

    <!-- 3) æ’­æ”¾ -->
    <div class="card" style="flex:1; min-width: 280px;">
      <h3>3) ä¾å½©åº¦æ’­æ”¾æ›²é¢¨</h3>
      <div class="muted">å½©åº¦ â†’ æ›²é¢¨ï¼š0â€“20 Jazzã€20â€“40 Funkã€40â€“60 Lo-fiã€60â€“80 Dream Popã€80â€“100 Rock</div>
      <div class="row" style="margin-top:10px;">
        <button id="btn-play" disabled>æ’­æ”¾ 4 å°ç¯€</button>
        <button id="btn-stop">åœæ­¢</button>
      </div>
      <h3 style="margin-top:14px;">Log</h3>
      <div id="log" class="log"></div>
    </div>
  </div>

<script>
/* ========================== å·¥å…· ========================== */
function rgbToHsl(r,g,b){
  r/=255; g/=255; b/=255;
  const max = Math.max(r,g,b), min=Math.min(r,g,b);
  let h,s,l=(max+min)/2;
  if(max===min){ h=s=0; }
  else{
    const d=max-min;
    s = l>0.5 ? d/(2-max-min) : d/(max+min);
    switch(max){
      case r: h=(g-b)/d+(g<b?6:0); break;
      case g: h=(b-r)/d+2; break;
      case b: h=(r-g)/d+4; break;
    }
    h/=6;
  }
  return [Math.round(h*360), Math.round(s*100), Math.round(l*100)];
}

/* ========================== ä¸Šå‚³èˆ‡é¡è‰²åˆ†æ ========================== */
let latestColors = null; // æœƒå­˜ {rgb: [...], hex: [...]}

document.getElementById('uploadBtn').addEventListener('click', async () => {
  const input = document.getElementById('photoInput');
  const file = input.files[0];
  if (!file) return alert('è«‹å…ˆé¸ä¸€å¼µç…§ç‰‡');

  const fd = new FormData();
  fd.append('photo', file);

  try {
    const res = await fetch('/upload', { method: 'POST', body: fd });
    if (!res.ok) throw new Error('ä¸Šå‚³å¤±æ•—');
    const data = await res.json();
    latestColors = data; // { rgb: [[r,g,b],...], hex: ["#..."] }

    // é¡¯ç¤ºè‰²å¡Š
    const sw = document.getElementById('swatches-upload');
    sw.innerHTML = '';
    data.hex.forEach(h => {
      const d = document.createElement('div');
      d.style.display = 'inline-block';
      d.style.width = '40px';
      d.style.height = '40px';
      d.style.marginRight = '6px';
      d.style.borderRadius = '6px';
      d.style.border = '1px solid #333';
      d.style.background = h;
      sw.appendChild(d);
    });

    console.log('æŠ“åˆ°è‰²å¡Šï¼š', data);

    // ğŸµ æ ¹æ“šå½©åº¦æ±ºå®šæ›²é¢¨
    if (data.rgb.length > 0) {
      const [r,g,b] = data.rgb[0];
      const [h,s,l] = rgbToHsl(r,g,b);
      let gname = "â€”";
      if (s < 20) gname = "Jazz";
      else if (s < 40) gname = "Funk";
      else if (s < 60) gname = "Lo-fi";
      else if (s < 80) gname = "Dream Pop";
      else gname = "Rock";
      document.getElementById("genre-pill").textContent = `æ›²é¢¨ï¼š${gname}`;
    }

    document.getElementById("btn-play").disabled = false;
    alert('åˆ†æå®Œæˆï¼æŒ‰æ’­æ”¾å³å¯è½éŸ³æ¨‚ï¼ˆæˆ–æ¥ä¸‹å»çš„æµç¨‹ï¼‰');
  } catch (e) {
    console.error(e);
    alert('ä¸Šå‚³æˆ–åˆ†æå¤±æ•—ï¼š' + e.message);
  }
});

/* ========================== æ’­æ”¾éµç¶å®š ========================== */
const playBtn = document.getElementById('btn-play');
if (playBtn) {
  playBtn.addEventListener('click', () => {
    if (!latestColors) return alert('è«‹å…ˆä¸Šå‚³ç…§ç‰‡ä¸¦åˆ†æè‰²å¡Š');
    console.log('æº–å‚™é–‹å§‹æ’­æ”¾ï¼Œä½¿ç”¨è‰²å¡Šï¼š', latestColors);
    // TODO: å‘¼å«ä½ çš„éŸ³æ¨‚ç¨‹å¼ç¢¼ï¼Œå‚³å…¥ latestColors
    // ç¯„ä¾‹ï¼šstartMusicWithColors(latestColors.hex);
  });
}
</script>
</body>
</html>